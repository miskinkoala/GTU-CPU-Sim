#.define MAX_THREADS 10
#.define THREAD_ENTRY_SIZE 10
#.define OS_RUNNING 1

#.ifndef DISABLE_DEBUG
#.define PRINT_DEBUG SYSCALL PRN
#.else
#.define PRINT_DEBUG # Debug disabled
#.endif

#.ifdef ENABLE_FACTORIAL
#.define FACTORIAL_INPUT 5
#.else
#.define FACTORIAL_INPUT 3
#.endif

#GTU-C312 Complex Preprocessor Test
Begin Data Section
# CPU Registers
$PC 100
$SP 1000
$SYSCALL_RES 0
$INSTR_COUNT 0

# OS Data
@OS_STATE OS_RUNNING
@THREAD_COUNT MAX_THREADS
@CURRENT_THREAD 0

# Thread table (MAX_THREADS * THREAD_ENTRY_SIZE words)
@THREAD_TABLE_BASE 40

# Test data
1000 FACTORIAL_INPUT
1001 0
1002 1
End Data Section

Begin Instruction Section
100 SET 0 $ZERO
101 SET OS_RUNNING @OS_STATE
102 SET MAX_THREADS @THREAD_COUNT
103 CPY @THREAD_TABLE_BASE $TEMP1
104 ADD $TEMP1 THREAD_ENTRY_SIZE
106 SET FACTORIAL_INPUT 1000
107 CALL 200
108 HLT

# Factorial subroutine
200 CPY 1000 $PARAM1
201 SET 1 1001
202 JIF $PARAM1 210
203 CALL 220
204 RET
210 SYSCALL PRN 1001
211 RET

# Multiply helper
220 CPY 1001 $TEMP1
221 CPY $PARAM1 $TEMP2
222 ADD 1001 $TEMP1
223 ADD $PARAM1 -1
224 JIF $PARAM1 230
225 SET 222 0
230 RET
End Instruction Section
